#!/bin/bash
echo " PLEASE READ THE END OF THE SCRIPT, IT IS IMPORTANT"
cat << EOF
*,************,(&&&&&&&&@&&&&%,,,,,,,,,*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
***,,***,,,,,**&&&@&&&&&&&&&&&&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*
**,,,,*,,**,,*%&&&@&&&&&&&&&&&&@,,,*,,*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
,**,,,,,,,,,,,&&&&&&&&&&&&&&&&&&&,,,,,,,,,*,,,,,,,,,,,,,*,,,,,,.,.,,,,,,,,,,,*%%
,,,,,,,,,,,,,*&&&&&&&@&&@@&@&@@&&&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,,,,*&&&&&&
,,,,,,,,,,,,,,%&&&@&&&@&@@@@&@@&&&&%%%%%%%%%%((*,,,,,,,,,,,,,,,.,,,,*(%&&&&&&&&&
,,,,,,,,,,,,,,&&&@@&@&@&&@@@@@@&@@&&&&&&&&&&&&&&%%%%(///*****(%&%&&&&&&&&&&&&&&/
,,,,,,,,,,,,,*&&&&&@@&@@@@@@@@@@@@@@&&&&&&&&&&&&&&&&&&&%&&&&&&&&&&&&&&&&&%%&%/,,
,,,,,,,,,,,,,*&&&&@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&%&%&/,,,,
,,,,,,,,,,,,,,#&&&@@@@@@&&@@@@@@@@@@@@@@&&&&&&@@@&@&&&&&@&&&&@&&&&&&&&&&&%*,,,,,
,,,,,,,,,,,,,,#&@@&&@@@@&@@@@@@&@@@@@@@@@@@@@@@@@&@&&&&&&&&@@&&&&&&&&&&&*,,,...,
,,,,,,,,,,,,(&&&&@&&@&@@@@@@@@@@@@@@@@@@@@@@@@@@@&@@&@@@@@@&@@&&&&&&&&&*....,...
,,,,,,,,,,*#&&&&&&@@@@@@@@@@@@@@&@&@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&%/.,,,,,,..
,,,,,,,,,*#%&&&&&@@@&&@@&&&&&&&&@&@@@@@@@@@@@@@@@@@@@@@@@@@@&@&&&&&&&,,.,.,,..,.
,,,,,,,,,(%&&&&&&&&&&&&&@&&&&@&&&&@@@@@@@@@@@@@@@@@@@@@@&@&@&&@&&&&&%/,,.....,..
,,,,,,,,*#&&&&&&&&&@&@&@@@@@&&&&&&&&@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&%%*..,,..,..
,,,,,,,,*#&&&&&&&&&@&@@@@@&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&%%/,...,....
,,,,,,,,/%&&&&&@&&@@@@@@@@@@&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@&&&&%&&&&%%%(,,..,....
,,,,,,,*/&&&&&&&&&&&&@@@@@&@&%&@@@@@@@@@@@@@@@@@@@@@@@&@@&&&&&&&%%&&%%/,.....,,.
,,,,,,,*(&&&&&&&&@&&&@@@&&&%%%&@@@@&&@@@@@@@@@@@@@@@@@&@@&&&%%&&%%%&%#,.........
,,,,,,,*/%&&&&&&&&&&@@@@@@@&&&/(%%&&@@@@@@@@@@@@@@@@@@&%&&&@&#&&&&%%%*...,......
,,,,,,,*#&&&&&&&@@@@@&&@@@@@@@&&&&&&%@&@@@@@@@@@@@@@&@#/#%&#(#%&&%%%/,,,........
,,,,,,,/%&&&&@@@@@@@@@&@@@@@@@@@@@&@&&&@@@@@@@@@@@@@%&&%%%%%&&&&%%#/,...........
,,,,,,,#&&&&&@@@@@@@@@@@@@@@@@@@@&&&&&@@@@@@&&&@@@@&&&&&&&&&&&%%%#*,............
,,,,,,/%&&&&&&@@@@@@@@@@@@@@@@@@&&&&&&@@@@@&&&&&@@@&&&&&&&&&&%%%(,.....,.....,..
,,,,,*#&&&&&@@@@@&&&&@@&&@@@@@@@&&&&&&@@@&&&&&&&&@&&&&&&&&&&&&%*,,.,.,....,.....
,,,,*(&&&&&&@@@@@@@@@@@@&@@&&&@@@@&&&&&@@&&&&&&&&@&&&&&&&&&&&%(,....,...,.......
,,,*/%&&&&&&&&&&@@@@@&@@@@@@@@@@@@&@@@&@@@&&&&&&&&&&&&&&&&&&&%(,,,,............,
**/#&&&&&&&&&&@@&&@@@@@@@@&@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&&%#,,,,,.......,..,.
*/%&&&&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@&&@@@@&@@&&&&&&&&&&&&&%#*,,,.,,.,,.....,,
(%&&&&&&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&%%*,,,,.,,...,,,,,,
#%&&&&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&%%%*,,.,,.,,,,.,.,,,
%&&&@@&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&@&&&&%%%/,,,,,,,,,,,,.,,,
&&&@@@&&&&&&&@@@@@@@@@@@@@@@@@@@%@@@@@%&%&&&&&@@@@@@@@&&&&&&&%#*,,,,,,,,,,,,,,,,
&&&@@@&&@&&&&&@@@@@@@@@@@@@@@@&@@@@@@%%&&&%@@@@@@@@@@@@&&&&&&%/,,,,,,,,,,,,,,,,,
&&&@@@&&@&@&&&&@@@@@@@@@@@@@@@@@@@@&&@&&&%&&&&&&@@@@&&&&&&&&%/,,,,,,,,,,,,,,,,,,
&&@@@@&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@&@@@&&&&&@&&&&&&&&&&&&&%/*,,,,,,,,,,,,,,,,,
&&&@@@@&&@&&&@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&@@&&&&&&%#*,,,,,,,,,,,,,,,,,,
&&@@@@&&&@&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&@@&&&&@&&&&&%%/**,,,,,,,,,,,.,,,,,
@@&@@@@@&@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&@&@@&&@&&&&&&&%#*,,,,,,,,,,,*,,,,,,
&&&@@@@@&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@&&@@@&@@@&&@&&&&&&&&&&%#/,,,,,,,,,,,,,,,,,
&@@@@@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@&&@@@@@&&@@@&&&&&&&&&&%#*,,,,,,,,,,,,,,,,
@&@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&@@@&@&@&&&&&&&&&&&&#/,,,,,,,*,*,,,,**
&&&@@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&%/*,,,,,,,,,**,,,,
&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&%*,,,,,*,,*,*,****
&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&@@@@@@&@@@&&&&&&&&&&&#*.,**,,,,******,*
&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&%#*..,*************
&@&&@&@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&%(*,...************
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&@&&&&&&&&&&&&&&&#*,......,**********
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&@&&&@&@&@&&&&&&&%/,........,******/**
&@@@@@@@@@@@@@@@@&@&@@@@&&&&@@@@@@@@&@&&&&&&&&&&&&&&&&&&&##/,..........,***/*/*/
&@@@@@@@@@@@@@@&@&@&&&&@&&&&&@&@@@@@@&&@@&&&&&&&&&&&&&&&%(*,,............*/**///
&&&&@@@@@@@@@@@@@@&@&&@@@@&&&&&@@@@@@@&&&&&&&&&&&&&&&&&&&#*,............../#(///
&&&&&&&@@@@@@@@@@@@@&@@@&@&&&&@@@@@@&@&&&&&&&&&&&&&&&&&&&&#,......,,,,,....*%%%%
&&&&&@&&@@@@@@@@@@@@&&@@@&&&&&&@@@@&@&&&&&&&&&&&&&&&&&&&&&&(///////*****....,%%%
#%%&&@@@@@&@@&@@@@@@@&&&&&@&&&&@@@&&&&&&@@@&&@@@@&&@@@&&&&&#/////////////,...,#%
##%%&&&@@@@@@@@@@@@@@@&&&&&&&&&@@&&&&&@@&@@&@@@@@@@@@&@@@&&&(/////////////,...,#
EOF
sleep 5
echo "Updating and installing dependencies..."
apk update && apk add --no-cache \
  bash \
  build-base \
  git \
  curl \
  wget \
  linux-headers \
  pcre-dev \
  zlib-dev \
  openssl-dev \
  libtool \
  autoconf \
  automake \
  libxml2-dev \
  libmaxminddb-dev \
  yajl-dev \
  lmdb-dev \
  lua-dev \
  unzip \
  gcc \
  g++ \
  make

echo "Downloading and installing OpenSSL..."
wget https://www.openssl.org/source/openssl-1.1.1.tar.gz
tar xvf openssl-1.1.1.tar.gz
cd openssl-1.1.1
./config --prefix=/usr --openssldir=/etc/ssl --libdir=lib no-shared zlib-dynamic
make && make install
cd ..
rm -rf openssl-1.1.1.tar.gz openssl-1.1.1

echo "Downloading and installing ModSecurity..."
git clone https://github.com/SpiderLabs/ModSecurity.git
cd ModSecurity
git checkout -b v3/master origin/v3/master
git submodule init
git submodule update
sh build.sh
./configure
make && make install
cd ..
rm -rf ModSecurity

echo "Downloading and preparing Nginx with ModSecurity and NTLM..."
wget http://nginx.org/download/nginx-1.28.0.tar.gz
tar xvf nginx-1.28.0.tar.gz
git clone https://github.com/SpiderLabs/ModSecurity-nginx.git
git clone https://github.com/jaweewo/nginx-ntlm-module.git

cd nginx-1.28.0
./configure --prefix=/usr/local/nginx \
  --with-http_ssl_module \
  --with-http_stub_status_module \
  --add-module=../ModSecurity-nginx \
  --add-module=../nginx-ntlm-module \
  --with-cc-opt="-Wno-error"
make && make install
cd ..
rm -rf nginx-1.28.0 nginx-1.28.0.tar.gz ModSecurity-nginx nginx-ntlm-module

echo "Setting up ModSecurity configuration..."
mkdir -p /usr/local/nginx/conf/modsecurity
cp /usr/local/modsecurity/etc/modsecurity.conf-recommended /usr/local/nginx/conf/modsecurity/modsecurity.conf
cp /usr/local/modsecurity/unicode.mapping /usr/local/nginx/conf/modsecurity/

echo "Downloading OWASP Core Rule Set (CRS)..."
wget https://github.com/coreruleset/coreruleset/archive/refs/heads/v3.3/dev.zip -O owasp-modsecurity-crs-3.3-dev.zip
unzip owasp-modsecurity-crs-3.3-dev.zip
mv coreruleset-3.3-dev /usr/local/nginx/conf/modsecurity/crs
cp /usr/local/nginx/conf/modsecurity/crs/crs-setup.conf.example /usr/local/nginx/conf/modsecurity/crs/crs-setup.conf
rm -rf owasp-modsecurity-crs-3.3-dev.zip

echo "Finalizing ModSecurity setup..."
cd /usr/local/nginx/conf/modsecurity/crs/rules
for f in *.example; do mv "$f" "${f%.example}"; done

echo "Cleaning up..."
apk del build-base git curl wget linux-headers gcc g++ make autoconf automake libtool unzip
rm -rf /var/cache/apk/*

echo "## Installation complete! Follow these instructions to enable ModSecurity:
# 1. Edit /usr/local/nginx/conf/nginx.conf
#    - Add the following to the HTTP block:
#      modsecurity on;
#      modsecurity_rules_file /usr/local/nginx/conf/modsecurity/modsecurity.conf;
# 2. Update ModSecurity configuration:
#    - Edit /usr/local/nginx/conf/modsecurity/modsecurity.conf
#      Change 'SecRuleEngine DetectionOnly' to 'SecRuleEngine On'.
#    - Include CRS setup and rules in modsecurity.conf:
#      Include /usr/local/nginx/conf/modsecurity/crs/crs-setup.conf
#      Include /usr/local/nginx/conf/modsecurity/crs/rules/*.conf
# 3. Reload Nginx:
#      /usr/local/nginx/sbin/nginx -s reload"
