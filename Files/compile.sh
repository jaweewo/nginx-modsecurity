#!/bin/bash
echo " PLEASE READ THE END OF THE SCRIPT, IT IS IMPORTANT"
cat << EOF
*,************,(&&&&&&&&@&&&&%,,,,,,,,,*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
***,,***,,,,,**&&&@&&&&&&&&&&&&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*
**,,,,*,,**,,*%&&&@&&&&&&&&&&&&@,,,*,,*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
,**,,,,,,,,,,,&&&&&&&&&&&&&&&&&&&,,,,,,,,,*,,,,,,,,,,,,,*,,,,,,.,.,,,,,,,,,,,*%%
,,,,,,,,,,,,,*&&&&&&&@&&@@&@&@@&&&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,,,,*&&&&&&
,,,,,,,,,,,,,,%&&&@&&&@&@@@@&@@&&&&%%%%%%%%%%((*,,,,,,,,,,,,,,,.,,,,*(%&&&&&&&&&
,,,,,,,,,,,,,,&&&@@&@&@&&@@@@@@&@@&&&&&&&&&&&&&&%%%%(///*****(%&%&&&&&&&&&&&&&&/
,,,,,,,,,,,,,*&&&&&@@&@@@@@@@@@@@@@@&&&&&&&&&&&&&&&&&&&%&&&&&&&&&&&&&&&&&%%&%/,,
,,,,,,,,,,,,,*&&&&@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&%&%&/,,,,
,,,,,,,,,,,,,,#&&&@@@@@@&&@@@@@@@@@@@@@@&&&&&&@@@&@&&&&&@&&&&@&&&&&&&&&&&%*,,,,,
,,,,,,,,,,,,,,#&@@&&@@@@&@@@@@@&@@@@@@@@@@@@@@@@@&@&&&&&&&&@@&&&&&&&&&&&*,,,...,
,,,,,,,,,,,,(&&&&@&&@&@@@@@@@@@@@@@@@@@@@@@@@@@@@&@@&@@@@@@&@@&&&&&&&&&*....,...
,,,,,,,,,,*#&&&&&&@@@@@@@@@@@@@@&@&@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&%/.,,,,,,..
,,,,,,,,,*#%&&&&&@@@&&@@&&&&&&&&@&@@@@@@@@@@@@@@@@@@@@@@@@@@&@&&&&&&&,,.,.,,..,.
,,,,,,,,,(%&&&&&&&&&&&&&@&&&&@&&&&@@@@@@@@@@@@@@@@@@@@@@&@&@&&@&&&&&%/,,.....,..
,,,,,,,,*#&&&&&&&&&@&@&@@@@@&&&&&&&&@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&%%*..,,..,..
,,,,,,,,*#&&&&&&&&&@&@@@@@&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&%%/,...,....
,,,,,,,,/%&&&&&@&&@@@@@@@@@@&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@&&&&%&&&&%%%(,,..,....
,,,,,,,*/&&&&&&&&&&&&@@@@@&@&%&@@@@@@@@@@@@@@@@@@@@@@@&@@&&&&&&&%%&&%%/,.....,,.
,,,,,,,*(&&&&&&&&@&&&@@@&&&%%%&@@@@&&@@@@@@@@@@@@@@@@@&@@&&&%%&&%%%&%#,.........
,,,,,,,*/%&&&&&&&&&&@@@@@@@&&&/(%%&&@@@@@@@@@@@@@@@@@@&%&&&@&#&&&&%%%*...,......
,,,,,,,*#&&&&&&&@@@@@&&@@@@@@@&&&&&&%@&@@@@@@@@@@@@@&@#/#%&#(#%&&%%%/,,,........
,,,,,,,/%&&&&@@@@@@@@@&@@@@@@@@@@@&@&&&@@@@@@@@@@@@@%&&%%%%%&&&&%%#/,...........
,,,,,,,#&&&&&@@@@@@@@@@@@@@@@@@@@&&&&&@@@@@@&&&@@@@&&&&&&&&&&&%%%#*,............
,,,,,,/%&&&&&&@@@@@@@@@@@@@@@@@@&&&&&&@@@@@&&&&&@@@&&&&&&&&&&%%%(,.....,.....,..
,,,,,*#&&&&&@@@@@&&&&@@&&@@@@@@@&&&&&&@@@&&&&&&&&@&&&&&&&&&&&&%*,,.,.,....,.....
,,,,*(&&&&&&@@@@@@@@@@@@&@@&&&@@@@&&&&&@@&&&&&&&&@&&&&&&&&&&&%(,....,...,.......
,,,*/%&&&&&&&&&&@@@@@&@@@@@@@@@@@@&@@@&@@@&&&&&&&&&&&&&&&&&&&%(,,,,............,
**/#&&&&&&&&&&@@&&@@@@@@@@&@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&&%#,,,,,.......,..,.
*/%&&&&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@&&@@@@&@@&&&&&&&&&&&&&%#*,,,.,,.,,.....,,
(%&&&&&&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&%%*,,,,.,,...,,,,,,
#%&&&&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&%%%*,,.,,.,,,,.,.,,,
%&&&@@&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&@&&&&%%%/,,,,,,,,,,,,.,,,
&&&@@@&&&&&&&@@@@@@@@@@@@@@@@@@@%@@@@@%&%&&&&&@@@@@@@@&&&&&&&%#*,,,,,,,,,,,,,,,,
&&&@@@&&@&&&&&@@@@@@@@@@@@@@@@&@@@@@@%%&&&%@@@@@@@@@@@@&&&&&&%/,,,,,,,,,,,,,,,,,
&&&@@@&&@&@&&&&@@@@@@@@@@@@@@@@@@@@&&@&&&%&&&&&&@@@@&&&&&&&&%/,,,,,,,,,,,,,,,,,,
&&@@@@&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@&@@@&&&&&@&&&&&&&&&&&&&%/*,,,,,,,,,,,,,,,,,
&&&@@@@&&@&&&@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&@@&&&&&&%#*,,,,,,,,,,,,,,,,,,
&&@@@@&&&@&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&@@&&&&@&&&&&%%/**,,,,,,,,,,,.,,,,,
@@&@@@@@&@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&@&@@&&@&&&&&&&%#*,,,,,,,,,,,*,,,,,,
&&&@@@@@&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@&&@@@&@@@&&@&&&&&&&&&&%#/,,,,,,,,,,,,,,,,,
&@@@@@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@&&@@@@@&&@@@&&&&&&&&&&%#*,,,,,,,,,,,,,,,,
@&@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&@@@&@&@&&&&&&&&&&&&#/,,,,,,,*,*,,,,**
&&&@@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&%/*,,,,,,,,,**,,,,
&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&%*,,,,,*,,*,*,****
&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&@@@@@@&@@@&&&&&&&&&&&#*.,**,,,,******,*
&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&%#*..,*************
&@&&@&@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&%(*,...************
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&@&&&&&&&&&&&&&&&#*,......,**********
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&@&&&@&@&@&&&&&&&%/,........,******/**
&@@@@@@@@@@@@@@@@&@&@@@@&&&&@@@@@@@@&@&&&&&&&&&&&&&&&&&&&##/,..........,***/*/*/
&@@@@@@@@@@@@@@&@&@&&&&@&&&&&@&@@@@@@&&@@&&&&&&&&&&&&&&&%(*,,............*/**///
&&&&@@@@@@@@@@@@@@&@&&@@@@&&&&&@@@@@@@&&&&&&&&&&&&&&&&&&&#*,............../#(///
&&&&&&&@@@@@@@@@@@@@&@@@&@&&&&@@@@@@&@&&&&&&&&&&&&&&&&&&&&#,......,,,,,....*%%%%
&&&&&@&&@@@@@@@@@@@@&&@@@&&&&&&@@@@&@&&&&&&&&&&&&&&&&&&&&&&(///////*****....,%%%
#%%&&@@@@@&@@&@@@@@@@&&&&&@&&&&@@@&&&&&&@@@&&@@@@&&@@@&&&&&#/////////////,...,#%
##%%&&&@@@@@@@@@@@@@@@&&&&&&&&&@@&&&&&@@&@@&@@@@@@@@@&@@@&&&(/////////////,...,#
EOF
sleep 5
echo "Updating"
yum update 
echo "Installing the requirements for SSL"
wget --no-check-certificate https://ftp.openssl.org/source/old/1.1.1/openssl-1.1.1.tar.gz
yum install -y make gcc perl pcre-devel zlib-devel 
tar xvf openssl-1.1.1.tar.gz
echo "Changing to openssl folder"
cd openssl-1.1.1
./config --prefix=/usr --openssldir=/etc/ssl --libdir=lib no-shared zlib-dynamic
echo "Compiling"
make && make install
echo "Exporting libraries"
export LD_LIBRARY_PATH=/usr/local/lib:/usr/local/lib64
echo "export LD_LIBRARY_PATH=/usr/local/lib:/usr/local/lib64" >> ~/.bashrc
echo "Checking OpenSSL version"
openssl version

echo "Install dependent tools for Nginx and Modsecurity"
yum install -y git wget epel-release gcc-c++ flex bison yajl yajl-devel curl-devel curl GeoIP-devel doxygen zlib-devel pcre-devel lmdb-devel libxml2-devel ssdeep-devel lua-devel libtool autoconf automake
cd /usr/local
echo "installing ModSecurity"
git clone https://github.com/SpiderLabs/ModSecurity
cd ModSecurity
git checkout -b v3/master origin/v3/master
git submodule init
git submodule update
sh build.sh
./configure

make && make install
echo "Installing nginx with ModSecurity and SSL"
cd /usr/local
git clone https://github.com/SpiderLabs/ModSecurity-nginx
wget http://nginx.org/download/nginx-1.23.3.tar.gz
tar -xvzf nginx-1.23.3.tar.gz
cd /usr/local/nginx-1.23.3
./configure --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --with-http_ssl_module --add-module=/usr/local/ModSecurity-nginx
make && make install
echo "Starting nginx"
/usr/local/nginx/sbin/nginx

## WAF RULES
echo "Waf Rules"
mkdir -p /usr/local/nginx/conf/modsecurity
cp /usr/local/ModSecurity/modsecurity.conf-recommended /usr/local/nginx/conf/modsecurity/modsecurity.conf
cp /usr/local/ModSecurity/unicode.mapping /usr/local/nginx/conf/modsecurity/
cd /usr/local
wget http://www.modsecurity.cn/download/corerule/owasp-modsecurity-crs-3.3-dev.zip
unzip owasp-modsecurity-crs-3.3-dev.zip
cd owasp-modsecurity-crs-3.3-dev
cp crs-setup.conf.example /usr/local/nginx/conf/modsecurity/crs-setup.conf
cp -r rules /usr/local/nginx/conf/modsecurity
cd /usr/local/nginx/conf/modsecurity/rules
mv REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf.example REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf
mv  RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.example  RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf
echo "## FOR MAKING THIS WORK YOU NEED TO CHANGE SOME THINGS
# ON NGINX CONF --> ADD THIS ON HTTP BLOCK
#modsecurity on;
#modsecurity_rules_file /usr/local/nginx/conf/modsecurity/modsecurity.conf;
# EDIT /usr/local/nginx/conf/modsecurity/modsecurity.conf 
# CHANGE --> SecRuleEngine DetectionOnly to SecRuleEngine On
# ADD --> Include /usr/local/nginx/conf/modsecurity/crs-setup.conf
#         Include /usr/local/nginx/conf/modsecurity/rules/*.conf"

/usr/local/nginx/sbin/nginx -s reload